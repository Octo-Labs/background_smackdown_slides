<!doctype html>
<html lang="en">

	<head>
		<meta charset="utf-8">

		<title>Background Smackdown</title>

		<meta name="description" content="Resque vs. Sidekiq">
		<meta name="author" content="Jeremy Green">

		<meta name="apple-mobile-web-app-capable" content="yes" />
		<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />

		<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

		<link rel="stylesheet" href="css/reveal.min.css">
		<link rel="stylesheet" href="css/theme/simple.css" id="theme">
    <link rel="stylesheet" href="css/custom.css" id="custom">

		<!-- For syntax highlighting -->
		<link rel="stylesheet" href="lib/css/zenburn.css">

    <link rel="stylesheet" href="lib/css/d3.box.css">
    <link rel="stylesheet" href="lib/css/nv.d3.css">

		<!-- If the query includes 'print-pdf', use the PDF print sheet -->
		<script>
			document.write( '<link rel="stylesheet" href="css/print/' + ( window.location.search.match( /print-pdf/gi ) ? 'pdf' : 'paper' ) + '.css" type="text/css" media="print">' );
		</script>

		<!--[if lt IE 9]>
		<script src="lib/js/html5shiv.js"></script>
		<![endif]-->
	</head>

	<body>

<div class="reveal">

<div class="slides">


<section>
  <h3>Background Smack-down</h3>
  <br /><br />
  <h3>Resque vs. Sidekiq</h3>
  <aside class="notes">
  </aside>
</section>

<section>
  <table border="0" class="vert-middle" width="100%">
    <tr>
      <td colspan="2">
        <h3>A bit about me</h3>
        <hr />
      </td>
    </tr>
    <tr>
      <td colspan="2">
        <br />
        <h3>Jeremy Green</h3>
        <h4>drummer, coder, entrepreneur, photographer, brewer</h4>
        <h4>okc dev community enthusiast - okcruby.org, okcjs.org</h4>
      </td>
    </tr>
    <tr>
      <td>
        <img src="img/octologo.png" class="no-border">
      </td>
      <td>
        @jagthedrummer <br />
        jeremy@octolabs.com <br />
        <a href="http://www.octolabs.com/">http://www.octolabs.com/</a>
      </td>
    </tr>
  </table>
  <aside class="notes">
    These items are in chronological order.<br />
    I've been drumming much more than half my life.<br />
    Coding, just about half.<br />
    * next fragment * <br />
    Thanks to Jesse and Vance of okcjs for organizing Thunder Plains.
    * next fragment * <br />
    I'm historically bad at Twitter, but trying to get better.<br />
    Contacting me through OctoLabs is more reliable.
  </aside>
</section>

<section>
  <h3>Resque vs. Sidekiq</h3>
  <br /><br />
  <h3>Functional Differences</h3>
  <br /><br />
  <h3 class="fragment fade-in">Forks vs. <span class="strike">Spoons</span> Threads</h3>
</section>

<section>
  <h2>Installing</h2>
  <pre><code>
  # Gemfile
  gem 'resque'
  gem 'sidekiq'
  </code></pre>

  <pre><code>
  $ bundle install
  </code></pre>
</section>

<section>
  <h2>Using Resque</h2>
  <pre><code>
  Resque.enqueue(ResqueWorker, job.id)
  </code></pre>
  <pre><code class="ruby">
  class ResqueWorker
    @queue = :jobs

    def self.perform(job_id)
      start_time = Time.now
      job = Job.find job_id
      job.process(start_time)
    end
  end
  </code></pre>
  <pre><code>
  $ COUNT=8 QUEUE=* rake resque:workers
  </code></pre>
</section>

<section>
  <h2>Using Sidekiq</h2>
  <pre><code>
  SidekiqWorker.perform_async(job.id)
  </code></pre>
  <pre><code class="ruby">
  class SidekiqWorker
    include Sidekiq::Worker

    def perform(job_id)
      start_time = Time.now
      job = Job.find job_id
      job.process(start_time)
    end
  end
  </code></pre>
  <pre><code>
  $ sidekiq -c 8
  </code></pre>
</section>

<section>
  <h2>Job - The "control"</h2>
  <pre><code class="ruby">
  class Job < ActiveRecord::Base
    def process(start_time)
      self.started_at = start_time
      process_impl
      self.ended_at = Time.now
      save!
    end

    def process_impl
      # do nothing.  Subclasses will do stuff.
    end
  end
  </code></pre>
</section>

<section>
  <pre><code class="ruby">
  class CpuJob < Job
    def process_impl
      BCrypt::Password.create(SecureRandom.hex(200),:cost => 14)
    end
  end
  </code></pre>

  <pre><code class="ruby">
  class IoJob < Job
    require 'open-uri'
    def process_impl
      open('http://localhost:5000/')
    end
  end
  </code></pre>
  <pre><code class="ruby">
  class MixedJob < Job
    def process_impl
      open('http://localhost:5000/?wait_time=1')
      BCrypt::Password.create(SecureRandom.hex(200),:cost => 14)
      open('http://localhost:5000/?wait_time=1')
    end
  end
  </code></pre>
</section>

<section>
  <h2>Slownatra</h2>
  <br />
  <pre class="fragment fade-in"><code class="ruby">
  require 'sinatra/base'
  class Slownatra < Sinatra::Base
    DEFAULT_WAIT = 2
    get '/' do
      @wait_time = params[:wait_time] || DEFAULT_WAIT
      @wait_time = Random.rand(10) if @wait_time == "random"
      sleep(@wait_time.to_i)
      erb :index
    end
  end
  </code></pre>
</section>

<section>
  <h2><span class="fragment fade-in">Un-</span>Scientific Methodology</h2>
  <ol class="fragment fade-in">
    <li>Start worker(s)</li>
    <li>Create batch</li>
    <li>Create jobs</li>
    <li>Queue jobs</li>
  </ol>
</section>

<section>
  <img src="img/science_cat.jpg" alt="" />
</section>

<section>
  <section id="job_charts" class="charts" data-json='js/data/job.json' data-chart-group='bar'>
    <h3>1000 Jobs</h3>
    <hr />
    <div class="row">
      <div class="col4">
        <b>Mean Processing Time</b>
        <div class="mean"><svg style="height:200px;"></svg></div>
      </div>
      <div class="col4">
        <b>95th% Processing Time</b>
        <div class="percentile95"><svg style="height:200px;"></svg></div>
      </div>
    </div>
    <div class="row">
      <div class="col4">
        <b>Total Processing Time</b>
        <div class="run_time"><svg style="height:200px;"></svg></div>
      </div>
      <div class="col4">
        <b>Elapsed Wall Time</b>
        <div class="wall_time"><svg style="height:200px;"></svg></div>
      </div>
    </div>
  </section>
  <section id="job_lines" class="charts" data-json='js/data/job.json' data-chart-group='scatter'>
    <h3>1000 Jobs</h3>
    <hr />
    <b>Processing Times</b>
    <div class="scatter-chart job_scatter"><svg style="height:250px;"></svg></div>
    <b>CPU Load</b>
    <div class="line-chart user_cpu_line"><svg></svg></div>
  </section>
</section>

<section>
  <section id="io_job_charts" class="charts" data-json='js/data/io_job.json' data-chart-group='bar'>
    <h3>200 IoJobs</h3>
    <hr />
    <div class="row">
      <div class="col4">
        <b>Mean Processing Time</b>
        <div class="mean"><svg style="height:200px;"></svg></div>
      </div>
      <div class="col4">
        <b>95th% Processing Time</b>
        <div class="percentile95"><svg style="height:200px;"></svg></div>
      </div>
    </div>
    <div class="row">
      <div class="col4">
        <b>Total Processing Time</b>
        <div class="run_time"><svg style="height:200px;"></svg></div>
      </div>
      <div class="col4">
        <b>Elapsed Wall Time</b>
        <div class="wall_time"><svg style="height:200px;"></svg></div>
      </div>
    </div>
  </section>
  <section id="io_job_lines" class="charts" data-json='js/data/io_job.json' data-chart-group='scatter'>
    <h3>200 IoJobs</h3>
    <hr />
    <b>Processing Times</b>
    <div class="scatter-chart job_scatter"><svg style="height:250px;"></svg></div>
    <b>CPU Load</b>
    <div class="line-chart user_cpu_line"><svg></svg></div>
  </section>
</section>

<section>
  <section id="cpu_job_charts" class="charts" data-json='js/data/cpu_job.json' data-chart-group='bar'>
    <h3>200 CpuJobs</h3>
    <hr />
    <div class="row">
      <div class="col4">
        <b>Mean Processing Time</b>
        <div class="mean"><svg style="height:200px;"></svg></div>
      </div>
      <div class="col4">
        <b>95th% Processing Time</b>
        <div class="percentile95"><svg style="height:200px;"></svg></div>
      </div>
    </div>
    <div class="row">
      <div class="col4">
        <b>Total Processing Time</b>
        <div class="run_time"><svg style="height:200px;"></svg></div>
      </div>
      <div class="col4">
        <b>Elapsed Wall Time</b>
        <div class="wall_time"><svg style="height:200px;"></svg></div>
      </div>
    </div>
  </section>
  <section id="cpu_job_lines" class="charts" data-json='js/data/cpu_job.json' data-chart-group='scatter'>
    <h3>200 CpuJobs</h3>
    <hr />
    <b>Processing Times</b>
    <div class="scatter-chart job_scatter"><svg style="height:250px;"></svg></div>
    <b>CPU Load</b>
    <div class="line-chart user_cpu_line"><svg></svg></div>
  </section>
</section>

<section>
  <section id="mixed_job_charts" class="charts" data-json='js/data/mixed_job.json' data-chart-group='bar'>
    <h3>200 MixedJobs</h3>
    <hr />
    <div class="row">
      <div class="col4">
        <b>Mean Processing Time</b>
        <div class="mean"><svg style="height:200px;"></svg></div>
      </div>
      <div class="col4">
        <b>95th% Processing Time</b>
        <div class="percentile95"><svg style="height:200px;"></svg></div>
      </div>
    </div>
    <div class="row">
      <div class="col4">
        <b>Total Processing Time</b>
        <div class="run_time"><svg style="height:200px;"></svg></div>
      </div>
      <div class="col4">
        <b>Elapsed Wall Time</b>
        <div class="wall_time"><svg style="height:200px;"></svg></div>
      </div>
    </div>
  </section>
  <section id="mixed_job_lines" class="charts" data-json='js/data/mixed_job.json' data-chart-group='scatter'>
    <h3>200 MixedJobs</h3>
    <hr />
    <b>Processing Times</b>
    <div class="scatter-chart job_scatter"><svg style="height:250px;"></svg></div>
    <b>CPU Load</b>
    <div class="line-chart user_cpu_line"><svg></svg></div>
  </section>
</section>



<section>
  <h3>What about memory use?</h3>
</section>

<section>
  <h3>Sidekiq 8 workers : At Rest</h3>
  <pre><code class="bash">
    $ sidekiq -c 8

    $ ps -o rss,pcpu,command -p $(pgrep -f sidekiq -d',')
   RSS  %CPU COMMAND
 78352   0.0 sidekiq 2.17.0 background_smackdown [0 of 8 busy]
  </code></pre>
</section>

<section>
  <h3>Sidekiq 8 Workers : While Working</h3>
  <pre><code class="bash">
    $ sidekiq -c 8
    $ ps -o rss,pcpu,command -p $(pgrep -f sidekiq -d',')
   RSS  %CPU COMMAND
 77116 107.3 sidekiq 2.17.0 background_smackdown [8 of 8 busy]
  </code></pre>
</section>

<section>
  <h3>Resque 8 Workers : At Rest</h3>
  <pre><code class="bash">
    $ COUNT=8 QUEUE=* rake resque:workers

    $ ps -o rss,pcpu,command -p $(pgrep -f resque -d',')
   RSS  %CPU COMMAND
 54124   0.0 ruby /Users/jgreen/.rvm/gems/ruby-2.0.0-p353/bin/rake resque:workers
 75688   0.0 resque-1.25.1: Waiting for *  
 75656   0.0 resque-1.25.1: Waiting for *  
 77284   0.0 resque-1.25.1: Waiting for *  
 76576   0.0 resque-1.25.1: Waiting for *  
 77144   0.0 resque-1.25.1: Waiting for *  
 76688   0.0 resque-1.25.1: Waiting for *  
 77620   0.0 resque-1.25.1: Waiting for *  
 74792   0.0 resque-1.25.1: Waiting for *
  </code></pre>
</section>


<section>
  <h3>Resque 8 Workers : At Rest</h3>
  <pre><code class="bash">
    $ COUNT=8 QUEUE=* rake resque:workers

    $ ps -o rss,pcpu,command -p $(pgrep -f resque -d',')
   RSS  %CPU COMMAND
 54124   0.0 ruby /Users/jgreen/.rvm/gems/ruby-2.0.0-p353/bin/rake resque:workers
 76292   5.8 resque-1.25.1: Forked 8004 at 1386358588  
 76344   5.3 resque-1.25.1: Forked 8007 at 1386358588  
 77736   6.6 resque-1.25.1: Forked 8016 at 1386358588  
 77004   5.7 resque-1.25.1: Forked 8000 at 1386358588  
 77444   6.3 resque-1.25.1: Forked 8008 at 1386358588  
 77072   6.6 resque-1.25.1: Forked 8009 at 1386358588  
 78124   5.4 resque-1.25.1: Forked 8003 at 1386358588  
 75276   6.0 resque-1.25.1: Forked 8006 at 1386358588  
 27772   8.8 resque-1.25.1: Processing jobs since 1386358588 [ResqueWorker]  
 27484   6.0 resque-1.25.1: Processing jobs since 1386358588 [ResqueWorker]  
 26752   5.7 resque-1.25.1: Processing jobs since 1386358588 [ResqueWorker]  
 23876   5.7 resque-1.25.1: Processing jobs since 1386358588 [ResqueWorker]  
 25040   5.2 resque-1.25.1: Processing jobs since 1386358588 [ResqueWorker]  
 24412   5.4 resque-1.25.1: Processing jobs since 1386358588 [ResqueWorker]
  </code></pre>
</section>

<section>
  <h2>Verdict?</h2>
  <br />
  <div class="fragment fade-in">
    <h3>Resque wins for CPU heavy jobs</h3>
    <br />
    <h3>Sidekiq wins for everything else</h3>
  </div>
  <br />
  <h2 class="fragment fade-in">Not so fast!</h2>
</section>

<section>
  <h2>Can we minimize the divide?</h2>
</section>

<section>
  <h2>Resque tweaks</h2>
  <pre><code>
  # Gemfile
  gem 'resque-multi-job-forks'
  </code></pre>
  <pre><code>
  $ JOBS_PER_FORK=1000 COUNT=8 QUEUE=* rake resque:workers
  </code></pre>
</section>

<section>
  <h2>Sidekiq tweaks</h2>
  <pre><code class="bash">
  $ sidekiq -c 1
  $ sidekiq -c 1
  $ sidekiq -c 1
  $ sidekiq -c 1
  $ sidekiq -c 1
  $ sidekiq -c 1
  $ sidekiq -c 1
  $ sidekiq -c 1
  </code></pre>
</section>



<section>
  <section id="job_charts_mod" class="charts" data-json='js/data/job_mod.json' data-chart-group='bar'>
    <h3>1000 Jobs (with tweaks)</h3>
    <hr />
    <div class="row">
      <div class="col4">
        <b>Mean Processing Time</b>
        <div class="mean"><svg style="height:200px;"></svg></div>
      </div>
      <div class="col4">
        <b>95th% Processing Time</b>
        <div class="percentile95"><svg style="height:200px;"></svg></div>
      </div>
    </div>
    <div class="row">
      <div class="col4">
        <b>Total Processing Time</b>
        <div class="run_time"><svg style="height:200px;"></svg></div>
      </div>
      <div class="col4">
        <b>Elapsed Wall Time</b>
        <div class="wall_time"><svg style="height:200px;"></svg></div>
      </div>
    </div>
  </section>
  <section id="job_lines_mod" class="charts" data-json='js/data/job_mod.json' data-chart-group='scatter'>
    <h3>1000 Jobs (with tweaks)</h3>
    <hr />
    <b>Processing Times</b>
    <div class="scatter-chart job_scatter"><svg style="height:250px;"></svg></div>
    <b>CPU Load</b>
    <div class="line-chart user_cpu_line"><svg></svg></div>
  </section>
</section>

<section>
  <section id="io_job_charts_mod" class="charts" data-json='js/data/io_job_mod.json' data-chart-group='bar'>
    <h3>200 IoJobs (with tweaks)</h3>
    <hr />
    <div class="row">
      <div class="col4">
        <b>Mean Processing Time</b>
        <div class="mean"><svg style="height:200px;"></svg></div>
      </div>
      <div class="col4">
        <b>95th% Processing Time</b>
        <div class="percentile95"><svg style="height:200px;"></svg></div>
      </div>
    </div>
    <div class="row">
      <div class="col4">
        <b>Total Processing Time</b>
        <div class="run_time"><svg style="height:200px;"></svg></div>
      </div>
      <div class="col4">
        <b>Elapsed Wall Time</b>
        <div class="wall_time"><svg style="height:200px;"></svg></div>
      </div>
    </div>
  </section>
  <section id="io_job_lines_mod" class="charts" data-json='js/data/io_job_mod.json' data-chart-group='scatter'>
    <h3>200 IoJobs (with tweaks)</h3>
    <hr />
    <b>Processing Times</b>
    <div class="scatter-chart job_scatter"><svg style="height:250px;"></svg></div>
    <b>CPU Load</b>
    <div class="line-chart user_cpu_line"><svg></svg></div>
  </section>
</section>

<section>
  <section id="cpu_job_charts_mod" class="charts" data-json='js/data/cpu_job_mod.json' data-chart-group='bar'>
    <h3>200 CpuJobs (with tweaks)</h3>
    <hr />
    <div class="row">
      <div class="col4">
        <b>Mean Processing Time</b>
        <div class="mean"><svg style="height:200px;"></svg></div>
      </div>
      <div class="col4">
        <b>95th% Processing Time</b>
        <div class="percentile95"><svg style="height:200px;"></svg></div>
      </div>
    </div>
    <div class="row">
      <div class="col4">
        <b>Total Processing Time</b>
        <div class="run_time"><svg style="height:200px;"></svg></div>
      </div>
      <div class="col4">
        <b>Elapsed Wall Time</b>
        <div class="wall_time"><svg style="height:200px;"></svg></div>
      </div>
    </div>
  </section>
  <section id="cpu_job_lines_mod" class="charts" data-json='js/data/cpu_job_mod.json' data-chart-group='scatter'>
    <h3>200 CpuJobs (with tweaks)</h3>
    <hr />
    <b>Processing Times</b>
    <div class="scatter-chart job_scatter"><svg style="height:250px;"></svg></div>
    <b>CPU Load</b>
    <div class="line-chart user_cpu_line"><svg></svg></div>
  </section>
</section>

<section>
  <section id="mixed_job_charts_mod" class="charts" data-json='js/data/mixed_job_mod.json' data-chart-group='bar'>
    <h3>200 MixedJobs (with tweaks)</h3>
    <hr />
    <div class="row">
      <div class="col4">
        <b>Mean Processing Time</b>
        <div class="mean"><svg style="height:200px;"></svg></div>
      </div>
      <div class="col4">
        <b>95th% Processing Time</b>
        <div class="percentile95"><svg style="height:200px;"></svg></div>
      </div>
    </div>
    <div class="row">
      <div class="col4">
        <b>Total Processing Time</b>
        <div class="run_time"><svg style="height:200px;"></svg></div>
      </div>
      <div class="col4">
        <b>Elapsed Wall Time</b>
        <div class="wall_time"><svg style="height:200px;"></svg></div>
      </div>
    </div>
  </section>
  <section id="mixed_job_lines_mod" class="charts" data-json='js/data/mixed_job_mod.json' data-chart-group='scatter'>
    <h3>200 MixedJobs (with tweaks)</h3>
    <hr />
    <b>Processing Times</b>
    <div class="scatter-chart job_scatter"><svg style="height:250px;"></svg></div>
    <b>CPU Load</b>
    <div class="line-chart user_cpu_line"><svg></svg></div>
  </section>
</section>





<section class="aleft">
  <h2>Other considerations</h2>
  <hr />
  <table border="0" width="100%">
    <tr>
      <td width="50%">
        <h3>Resque</h3>
        <ul>
          <li>Requires more memory*</li>
        </ul>
      </td>
      <td>
        <h3>Sidekiq</h3>
        <ul>
          <li>More processes to manage*</li>
          <li class="fragment fade-in">Requires thread safety</li>
        </ul>
      </td>
    </tr>
  </table>
  <p>*Maybe</p>
</section>




<section>
  <h2>An interesting mistake</h2>
  <pre><code class="ruby">
  class CpuJob < Job
    def process_impl
      (1..25000).inject(:*) || 1
    end
  end
  </code></pre>
  <img src="img/oops.jpg">
</section>









<section>
    <h2>Thanks For Watching!</h2>
    <div>
        <br>
    </div>
    <div>Jeremy Green</div>
    <div>
      @jagthedrummer
    </div>
    <div>jeremy@octolabs.com</div>
    <div>
        <br>
    </div>
    <div>
        <img src="img/octologo.png" class="no-border">
        <br>
    </div>
    <div>
        <br>
    </div>
    <div>
        <a href="http://www.octolabs.com/">http://www.octolabs.com/</a>
        <br>
    </div>
</section>

</div>
</div>

		<script src="lib/js/head.min.js"></script>
		<script src="js/reveal.min.js"></script>

    <script src="lib/js/jquery.min.js"></script>
    <script src="lib/js/d3.v3.js"></script>
    <script src="lib/js/d3.box.js"></script>
    <script src="lib/js/nv.d3.js"></script>

    <script src="js/charts.js"></script>

		<script>

			// Full list of configuration options available here:
			// https://github.com/hakimel/reveal.js#configuration
			Reveal.initialize({
				controls: true,
				progress: true,
				history: true,
				center: true,

				theme: Reveal.getQueryHash().theme, // available themes are in /css/theme
				transition: Reveal.getQueryHash().transition || 'default', // default/cube/page/concave/zoom/linear/fade/none

				// Optional libraries used to extend on reveal.js
				dependencies: [
					{ src: 'lib/js/classList.js', condition: function() { return !document.body.classList; } },
          //{ src: 'lib/js/raphael-min.js', async: true, condition: function() { return !!document.body.classList; } },
          //{ src: 'lib/js/underscore-min.js', async: true, condition: function() { return !!document.body.classList; } },
          //{ src: 'lib/js/sequence-diagram-min.js', async: true, condition: function() { return !!document.body.classList; } },

					{ src: 'plugin/markdown/showdown.js', condition: function() { return !!document.querySelector( '[data-markdown]' ); } },
					{ src: 'plugin/markdown/markdown.js', condition: function() { return !!document.querySelector( '[data-markdown]' ); } },
					{ src: 'plugin/highlight/highlight.js', async: true, callback: function() { hljs.initHighlightingOnLoad(); } },
					{ src: 'plugin/zoom-js/zoom.js', async: true, condition: function() { return !!document.body.classList; } },
					{ src: 'plugin/notes/notes.js', async: true, condition: function() { return !!document.body.classList; } }
					// { src: 'plugin/search/search.js', async: true, condition: function() { return !!document.body.classList; } }
					// { src: 'plugin/remotes/remotes.js', async: true, condition: function() { return !!document.body.classList; } }
				]
			});

      Reveal.addEventListener( 'slidechanged', function( event ) {
        $slide = $(event.currentSlide);
        if( $slide.data('chart-built') ){ return; }
        if( $slide.data('chart-group') == 'bar' ){
          setTimeout(function(){
            Batches.initBarChartGroup( '#' + $slide.attr('id'), $slide.data('json') );
          },550);
        }else if( $slide.data('chart-group') == 'scatter' ){
          setTimeout(function(){
            Batches.initScatterChartGroup( '#' + $slide.attr('id'), $slide.data('json') );
          },550);
        }
        $slide.data('chart-built',true);
        // event.previousSlide, event.currentSlide, event.indexh, event.indexv
      } );
		</script>

	</body>
</html>
